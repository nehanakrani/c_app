import e from"morphdom";var t=void 0;const n={INPUT:true,TEXTAREA:true,SELECT:true};const o={INPUT:true,TEXTAREA:true,OPTION:true};const r={"datetime-local":true,"select-multiple":true,"select-one":true,color:true,date:true,datetime:true,email:true,month:true,number:true,password:true,range:true,search:true,tel:true,text:true,textarea:true,time:true,url:true,week:true};let s;var a={get element(){return s},set(e){s=e}};const isTextInput=e=>n[e.tagName]&&r[e.type];const assignFocus=e=>{const t=e&&e.nodeType===Node.ELEMENT_NODE?e:document.querySelector(e);const n=t||a.element;n&&n.focus&&n.focus()};const dispatch=(e,t,n={})=>{const o={bubbles:true,cancelable:true,detail:n};const r=new CustomEvent(t,o);e.dispatchEvent(r);window.jQuery&&window.jQuery(e).trigger(t,n)};const xpathToElement=e=>document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;const getClassNames=e=>Array(e).flat();const processElements=(e,t)=>{Array.from(e.selectAll?e.element:[e.element]).forEach(t)};const kebabize=e=>e.split("").map(((e,t)=>e.toUpperCase()===e?`${0!==t?"-":""}${e.toLowerCase()}`:e)).join("");const operate=(e,t)=>{if(!e.cancel){e.delay?setTimeout(t,e.delay):t();return true}return false};const before=(e,t)=>dispatch(e,`cable-ready:before-${kebabize(t.operation)}`,t);const after=(e,t)=>dispatch(e,`cable-ready:after-${kebabize(t.operation)}`,t);function debounce(e,t){let n;return(...o)=>{clearTimeout(n);n=setTimeout((()=>e.apply(this,o)),t)}}function handleErrors(e){if(!e.ok)throw Error(e.statusText);return e}async function graciouslyFetch(e,t){try{const n=await fetch(e,{headers:{"X-REQUESTED-WITH":"XmlHttpRequest",...t}});if(void 0==n)return;handleErrors(n);return n}catch(t){console.error(`Could not fetch ${e}`)}}var c=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",isTextInput:isTextInput,assignFocus:assignFocus,dispatch:dispatch,xpathToElement:xpathToElement,getClassNames:getClassNames,processElements:processElements,operate:operate,before:before,after:after,debounce:debounce,handleErrors:handleErrors,graciouslyFetch:graciouslyFetch});const shouldMorph=e=>(t,n)=>!l.map((o=>"function"!==typeof o||o(e,t,n))).includes(false);const didMorph=e=>t=>{i.forEach((n=>{"function"===typeof n&&n(e,t)}))};const verifyNotMutable=(e,t,n)=>!(!o[t.tagName]&&t.isEqualNode(n));const verifyNotContentEditable=(e,t,n)=>t!==a.element||!t.isContentEditable;const verifyNotPermanent=(e,t,n)=>{const{permanentAttributeName:o}=e;if(!o)return true;const r=t.closest(`[${o}]`);if(!r&&t===a.element&&isTextInput(t)){const e={value:true};Array.from(n.attributes).forEach((n=>{e[n.name]||t.setAttribute(n.name,n.value)}));return false}return!r};const l=[verifyNotMutable,verifyNotPermanent,verifyNotContentEditable];const i=[];var u=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",shouldMorphCallbacks:l,didMorphCallbacks:i,shouldMorph:shouldMorph,didMorph:didMorph,verifyNotMutable:verifyNotMutable,verifyNotContentEditable:verifyNotContentEditable,verifyNotPermanent:verifyNotPermanent});var d={append:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{html:n,focusSelector:o}=e;t.insertAdjacentHTML("beforeend",n||"");assignFocus(o)}));after(t,e)}))},graft:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{parent:n,focusSelector:o}=e;const r=document.querySelector(n);if(r){r.appendChild(t);assignFocus(o)}}));after(t,e)}))},innerHtml:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{html:n,focusSelector:o}=e;t.innerHTML=n||"";assignFocus(o)}));after(t,e)}))},insertAdjacentHtml:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{html:n,position:o,focusSelector:r}=e;t.insertAdjacentHTML(o||"beforeend",n||"");assignFocus(r)}));after(t,e)}))},insertAdjacentText:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{text:n,position:o,focusSelector:r}=e;t.insertAdjacentText(o||"beforeend",n||"");assignFocus(r)}));after(t,e)}))},morph:t=>{processElements(t,(n=>{const{html:o}=t;const r=document.createElement("template");r.innerHTML=String(o).trim();t.content=r.content;const s=n.parentElement;const a=Array.from(s.children).indexOf(n);before(n,t);operate(t,(()=>{const{childrenOnly:o,focusSelector:s}=t;e(n,o?r.content:r.innerHTML,{childrenOnly:!!o,onBeforeElUpdated:shouldMorph(t),onElUpdated:didMorph(t)});assignFocus(s)}));after(s.children[a],t)}))},outerHtml:e=>{processElements(e,(t=>{const n=t.parentElement;const o=Array.from(n.children).indexOf(t);before(t,e);operate(e,(()=>{const{html:n,focusSelector:o}=e;t.outerHTML=n||"";assignFocus(o)}));after(n.children[o],e)}))},prepend:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{html:n,focusSelector:o}=e;t.insertAdjacentHTML("afterbegin",n||"");assignFocus(o)}));after(t,e)}))},remove:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{focusSelector:n}=e;t.remove();assignFocus(n)}));after(document,e)}))},replace:e=>{processElements(e,(t=>{const n=t.parentElement;const o=Array.from(n.children).indexOf(t);before(t,e);operate(e,(()=>{const{html:n,focusSelector:o}=e;t.outerHTML=n||"";assignFocus(o)}));after(n.children[o],e)}))},textContent:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{text:n,focusSelector:o}=e;t.textContent=n||"";assignFocus(o)}));after(t,e)}))},addCssClass:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{name:n}=e;t.classList.add(...getClassNames(n||""))}));after(t,e)}))},removeAttribute:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{name:n}=e;t.removeAttribute(n)}));after(t,e)}))},removeCssClass:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{name:n}=e;t.classList.remove(...getClassNames(n))}));after(t,e)}))},setAttribute:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{name:n,value:o}=e;t.setAttribute(n,o||"")}));after(t,e)}))},setDatasetProperty:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{name:n,value:o}=e;t.dataset[n]=o||""}));after(t,e)}))},setProperty:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{name:n,value:o}=e;n in t&&(t[n]=o||"")}));after(t,e)}))},setStyle:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{name:n,value:o}=e;t.style[n]=o||""}));after(t,e)}))},setStyles:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{styles:n}=e;for(let[e,o]of Object.entries(n))t.style[e]=o||""}));after(t,e)}))},setValue:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{value:n}=e;t.value=n||""}));after(t,e)}))},dispatchEvent:e=>{processElements(e,(t=>{before(t,e);operate(e,(()=>{const{name:n,detail:o}=e;dispatch(t,n,o)}));after(t,e)}))},setMeta:e=>{before(document,e);operate(e,(()=>{const{name:t,content:n}=e;let o=document.head.querySelector(`meta[name='${t}']`);if(!o){o=document.createElement("meta");o.name=t;document.head.appendChild(o)}o.content=n}));after(document,e)},clearStorage:e=>{before(document,e);operate(e,(()=>{const{type:t}=e;const n="session"===t?sessionStorage:localStorage;n.clear()}));after(document,e)},go:e=>{before(window,e);operate(e,(()=>{const{delta:t}=e;history.go(t)}));after(window,e)},pushState:e=>{before(window,e);operate(e,(()=>{const{state:t,title:n,url:o}=e;history.pushState(t||{},n||"",o)}));after(window,e)},redirectTo:e=>{before(window,e);operate(e,(()=>{let{url:t,action:n}=e;n=n||"advance";window.Turbo&&window.Turbo.visit(t,{action:n});window.Turbolinks&&window.Turbolinks.visit(t,{action:n});window.Turbo||window.Turbolinks||(window.location.href=t)}));after(window,e)},reload:e=>{before(window,e);operate(e,(()=>{window.location.reload()}));after(window,e)},removeStorageItem:e=>{before(document,e);operate(e,(()=>{const{key:t,type:n}=e;const o="session"===n?sessionStorage:localStorage;o.removeItem(t)}));after(document,e)},replaceState:e=>{before(window,e);operate(e,(()=>{const{state:t,title:n,url:o}=e;history.replaceState(t||{},n||"",o)}));after(window,e)},scrollIntoView:e=>{const{element:t}=e;before(t,e);operate(e,(()=>{t.scrollIntoView(e)}));after(t,e)},setCookie:e=>{before(document,e);operate(e,(()=>{const{cookie:t}=e;document.cookie=t||""}));after(document,e)},setFocus:e=>{const{element:t}=e;before(t,e);operate(e,(()=>{assignFocus(t)}));after(t,e)},setStorageItem:e=>{before(document,e);operate(e,(()=>{const{key:t,value:n,type:o}=e;const r="session"===o?sessionStorage:localStorage;r.setItem(t,n||"")}));after(document,e)},consoleLog:e=>{before(document,e);operate(e,(()=>{const{message:t,level:n}=e;n&&["warn","info","error"].includes(n)?console[n](t||""):console.log(t||"")}));after(document,e)},consoleTable:e=>{before(document,e);operate(e,(()=>{const{data:t,columns:n}=e;console.table(t,n||[])}));after(document,e)},notification:e=>{before(document,e);operate(e,(()=>{const{title:t,options:n}=e;Notification.requestPermission().then((o=>{e.permission=o;"granted"===o&&new Notification(t||"",n)}))}));after(document,e)}};let m=d;const add=e=>{m={...m,...e}};const addOperations=e=>{add(e)};const addOperation=(e,t)=>{const n={};n[e]=t;add(n)};var p={get all(){return m}};let h;const wait=()=>new Promise((e=>setTimeout(e)));const retryGetConsumer=async()=>{if(h)return h;await wait();return retryGetConsumer()};var f={setConsumer(e){h=e},async getConsumer(){return new Promise(((e,t)=>{h=retryGetConsumer();e(h)}))}};class SubscribingElement extends HTMLElement{disconnectedCallback(){this.channel&&this.channel.unsubscribe()}createSubscription(e,t,n){this.channel=e.subscriptions.create({channel:t,identifier:this.getAttribute("identifier")},{received:n})}get preview(){return document.documentElement.hasAttribute("data-turbolinks-preview")||document.documentElement.hasAttribute("data-turbo-preview")}}class StreamFromElement extends SubscribingElement{async connectedCallback(){if(this.preview)return;const e=await g.consumer;e?this.createSubscription(e,"CableReady::Stream",this.performOperations):console.error("The `stream_from` helper cannot connect without an ActionCable consumer.\nPlease run `rails generate cable_ready:helpers` to fix this.")}performOperations(e){e.cableReady&&g.perform(e.operations)}}const b="\n<style>\n  :host {\n    display: block;\n  }\n</style>\n<slot></slot>\n";function url(e){return e.hasAttribute("url")?e.getAttribute("url"):location.href}class UpdatesForElement extends SubscribingElement{constructor(){super();const e=this.attachShadow({mode:"open"});e.innerHTML=b}async connectedCallback(){if(this.preview)return;this.update=debounce(this.update.bind(this),this.debounce);const e=await g.consumer;e?this.createSubscription(e,"CableReady::Stream",this.update):console.error("The `updates-for` helper cannot connect without an ActionCable consumer.\nPlease run `rails generate cable_ready:helpers` to fix this.")}async update(t){const n=this.getAttribute("identifier");const o=`updates-for[identifier="${n}"]`;const r=document.querySelectorAll(o);if(r[0]!==this)return;const s=this.getAttribute("only");if(s&&t.changed&&!s.split(" ").some((e=>t.changed.includes(e))))return;const c={};const l=document.createElement("template");for(let t=0;t<r.length;t++){r[t].setAttribute("updating","updating");if(!c.hasOwnProperty(url(r[t]))){const e=await graciouslyFetch(url(r[t]),{"X-Cable-Ready":"update"});c[url(r[t])]=await e.text()}l.innerHTML=String(c[url(r[t])]).trim();await this.resolveTurboFrames(l.content);const n=l.content.querySelectorAll(o);if(n.length<=t){console.warn("Update aborted due to mismatched number of elements");return}a.set(document.activeElement);const s={element:r[t],html:n[t],permanentAttributeName:"data-ignore-updates"};dispatch(r[t],"cable-ready:before-update",s);e(r[t],n[t],{childrenOnly:true,onBeforeElUpdated:shouldMorph(s),onElUpdated:e=>{r[t].removeAttribute("updating");dispatch(r[t],"cable-ready:after-update",s);assignFocus(s.focusSelector)}})}}async resolveTurboFrames(e){const t=[...e.querySelectorAll('turbo-frame[src]:not([loading="lazy"])')];return Promise.all(t.map((t=>new Promise((async n=>{const o=await graciouslyFetch(t.getAttribute("src"),{"Turbo-Frame":t.id,"X-Cable-Ready":"update"});const r=document.createElement("template");r.innerHTML=await o.text();await this.resolveTurboFrames(r.content);e.querySelector(`turbo-frame#${t.id}`).innerHTML=String(r.content.querySelector(`turbo-frame#${t.id}`).innerHTML).trim();n()})))))}get debounce(){return this.hasAttribute("debounce")?parseInt(this.getAttribute("debounce")):20}}const perform=(e,t={emitMissingElementWarnings:true})=>{const n={};e.forEach((e=>{!e.batch||(n[e.batch]=n[e.batch]?++n[e.batch]:1)}));e.forEach((e=>{const o=e.operation;try{e.selector?e.element=e.xpath?xpathToElement(e.selector):document[e.selectAll?"querySelectorAll":"querySelector"](e.selector):e.element=document;if(e.element||t.emitMissingElementWarnings){a.set(document.activeElement);const t=p.all[o];if(t){t(e);!e.batch||0!==--n[e.batch]||dispatch(document,"cable-ready:batch-complete",{batch:e.batch})}else console.error(`CableReady couldn't find the "${o}" operation. Make sure you use the camelized form when calling an operation method.`)}}catch(t){if(e.element){console.error(`CableReady detected an error in ${o}: ${t.message}. If you need to support older browsers make sure you've included the corresponding polyfills. https://docs.stimulusreflex.com/setup#polyfills-for-ie11.`);console.error(t)}else console.warn(`CableReady ${o} failed due to missing DOM element for selector: '${e.selector}'`)}}))};const performAsync=(e,t={emitMissingElementWarnings:true})=>new Promise(((n,o)=>{try{n(perform(e,t))}catch(e){o(e)}}));const initialize=(e={})=>{const{consumer:t}=e;f.setConsumer(t);customElements.get("stream-from")||customElements.define("stream-from",StreamFromElement);customElements.get("updates-for")||customElements.define("updates-for",UpdatesForElement)};const y=f.getConsumer();var g={perform:perform,performAsync:performAsync,shouldMorphCallbacks:l,didMorphCallbacks:i,initialize:initialize,consumer:y,addOperation:addOperation,addOperations:addOperations,version:t,get DOMOperations(){console.warn("DEPRECATED: Please use `CableReady.operations` instead of `CableReady.DOMOperations`");return p.all},get operations(){return p.all}};export{u as MorphCallbacks,StreamFromElement,SubscribingElement,UpdatesForElement,c as Utils,g as default};

